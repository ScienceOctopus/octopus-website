---
title: Great circles with sf and leaflet
author: Martin John Hadley
date: '2018-02-28'
slug: great-circles-with-sf-and-leaflet
categories:
  - R
tags:
  - R
  - dataviz
draft: no
description: "Great circles are the shortest journeys between two points on a map, which can be easily computed and manipulated through the use of the excellent sf library, and visualised interactively with leaflet."
editor_options: 
  chunk_output_type: console
banner: "img/blog-images/header-images/2018-02-28_great-circles-with-sf.png"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

<!--html_preserve-->
<hr style="margin-top: -10px;margin-bottom: 5px;">
<div class="row">
    <div class="col-sm-4">
        <center> <span class="fa fa-star fa-2x text-center" style="color:Tomato"></span>
            <p><a href='/reproducability-ratings' data-toggle="tooltip" data-placement="right" title="" data-original-title="Click for info" style='font-weight:bold;color:black;text-decoration:underline;' target='_blank'>Citable Author<i class="fa fa-question-circle "></i></a>
                <br>
                Martin John Hadley
                <br>
                (<a href="https://orcid.org/0000-0002-3039-6849" target="orcid.widget" rel="noopener noreferrer" style="vertical-align:top;"  target='_blank'><img src="/img/orcid_16x16.png" style="width:1em;margin-right:.2em;" alt="ORCID iD icon">orcid.org/0000-0002-3039-6849</a>)
        </center>
    </div>
    <div class="col-sm-4">
        <center> <span class="fa fa-star fa-2x text-center" style="color:Tomato"></span>
            <p><a href='/reproducability-ratings' data-toggle="tooltip" data-placement="right" title="" data-original-title="Click for info" style='font-weight:bold;color:black;text-decoration:underline;' target='_blank'>Citable Data<i class="fa fa-question-circle "></i></a>
                <br>
                No real data used.
        </center>
    </div>
    <div class="col-sm-4">
        <center> <span class="fa fa-star-half-o fa-2x text-center" style="color:Tomato"></span>
            <p><a href='/reproducability-ratings' data-toggle="tooltip" data-placement="right" title="" data-original-title="Click for info" style='font-weight:bold;color:black;text-decoration:underline;' target='_blank'>Citable Code<i class="fa fa-question-circle "></i></a>
                <br>
                <a href="https://github.com/visibledata/visibledata.github.io/blob/master/content/blog/2018-02-28_great-circles-with-sf.Rmd" target="orcid.widget" rel="noopener noreferrer" style="vertical-align:top;"  target='_blank'><img src="/img/GitHub-Mark-32px.png" style="width:1em;margin-right:.5em;" alt="GitHub icon">.Rmd on GitHub</a>
        </center>
    </div>
</div>

<hr style="margin-top: 5px;margin-bottom: 5px;">

<!--/html_preserve-->

<div class="row">
<div class="col-sm-6">

Surprisingly often I'm asked to help folks build maps which visualise the journeys between geographic locations, in the bad old days of early 2017 I would have used the `geospheres` package and `sp`. 

That's because the shortest distance between two points on a map is a **great circle**, and `geospheres` is capable of computing sucgh things. Note that it's these great circles that you see on flight information screens, their exact curvature depends on the projection of the map.

</div>

<div class="col-sm-6">

<center><img src='/img/blog-images/header-images/2018-02-28_great-circles-with-sf.png' style='max-width:350px'/></center>

</div>

</div>
<br>
However, I'm now an `sf` convert and try to do everything within that package. Unfortunately, I almost always forget how to compute great circles between locations - so when I was asked to do it again this week I thought I'd formalise (and functionalise!) the process I go through.

Let's start with an example dataset of journeys I took during my 3 years working at Wolfram Research:

```{r create-journey-data, eval=FALSE, include=TRUE}
library("tidyverse")
library("sf")
raw_journey_data <- tribble(
  ~start.long, ~start.lat, ~end.long, ~end.lat, ~name,
  -0.118092, 	51.509865, -119.698189, 34.420830, "London to Santa Barbara",
  31.496773, 	30.026300, 24.753574, 59.436962, "New Cairo to Tallinn",
  126.633333, 45.75, 	46.738586, 24.774265, "Harbin to Riyadh"
)
raw_journey_data
```

```{r include = TRUE, echo = FALSE}
library("tidyverse")
library("sf")
library("DT")
raw_journey_data <- tribble(
  ~start.long, ~start.lat, ~end.long, ~end.lat, ~name,
  -0.118092, 	51.509865, -119.698189, 34.420830, "London to Santa Barbara",
  31.496773, 	30.026300, 24.753574, 59.436962, "New Cairo to Tallinn",
  126.633333, 45.75, 	46.738586, 24.774265, "Harbin to Riyadh"
)
dt_journeys <- datatable(raw_journey_data,
                             rownames = FALSE,
                             options = list(dom = "t",
                                            pageLength = 3))
widgetframe::frameWidget(dt_journeys, height = "100%")
```


We need to follow these steps:

1. Create an object called `journey_data_linestrings` with class `"sf" "data.frame"` containing LINESTRINGs from the start to end locations.
1. Combine this new object with our `raw_journey_data` to augment it ready for visualisation.

## Creating journey_data_linestrings

Let's use `dplyr` to extract out the `start_locs` and `end_locs`, noting that the `sf` library is fussy:

- `sf` wants longitude and latitude columns to be called `long` and `lat`, respectively.
- `sf` *often* cares about column order, we should ensure columns are ordered `long` then `lat`.

```{r extract-start-and-ends}
start_locs <- raw_journey_data %>%
  select(contains("start")) %>%
  rename(long = start.long,
         lat = start.lat) %>%
  mutate(journey.id = row_number())
end_locs <- raw_journey_data %>%
  select(contains("end")) %>%
  rename(long = end.long,
         lat = end.lat) %>%
  mutate(journey.id = row_number())
```

The `st_as_sf` allows us to convert a `data.frame` (or really `tibble` in this case) to an `sf` object, but note the complete lack of projection (proj4string) and EPSG as we'll need to account for that later:

```{r st-as-sf}
journey_data_linestrings <- start_locs %>%
  bind_rows(end_locs) %>%
  st_as_sf(coords = c("long","lat"))
journey_data_linestrings
```

Let's ensure to group and then arange the data by `journey.id` in preparation for combining the journey steps together:

```{r group-and-arrange}
journey_data_linestrings <- journey_data_linestrings %>%
  group_by(journey.id) %>%
  arrange(journey.id)
journey_data_linestrings
```

The `sf` library has a special method for `dplyr::summarise` that constructs a geometry from the latlong coordinates from the `group` column we defined above:  

```{r summarise-linestrings}
journey_data_linestrings <- journey_data_linestrings %>%
  summarise()
journey_data_linestrings
```

Now the final thing to do is `st_cast` these geometries as LINESTRINGs and add the WGS 84 coordinate reference system via `st_crs(4326)`

```{r st-cast-linestrings}
journey_data_linestrings <- journey_data_linestrings %>%
  sf::st_cast("LINESTRING")
journey_data_linestrings <- st_set_crs(journey_data_linestrings, st_crs(4326))
journey_data_linestrings
```

## Combining together

Combining these together is achieved by assigning the `st_geometry` component of `journey_data` the value of `st_geometry(journey_data_linestrings)`:

```{r insert-linestrings}
journey_data <- raw_journey_data
st_geometry(journey_data) <- st_geometry(journey_data_linestrings)
```

The magic sauce for calculating great circles is provided by `st_segmentize` and we can visualise the lines with `leaflet` with just three lines of code:

```{r basic-leaflet-map}
library("leaflet")
journey_data %>%
  st_segmentize(units::set_units(100, km)) %>%
  leaflet() %>%
  addTiles() %>%
  addPolylines()
```

<br>
A quick note to say, `leaflet` is an awesome `htmlwidget` for building interactive maps. If you've never heard of `htmlwidgets` before, check out my blogpost; [where's the love for htmlwidgets?](http://www.visibledata.co.uk/blog/2018/02/07/2018-02-07_where-s-the-love-for-htmlwidgets/)

Also! There's no **good** solution for turning these lines into arrows to denote the start and end points, instead I recommend placing circle markers:

```{r labelled-leaflet-map}
journey_data %>%
  st_segmentize(units::set_units(100, km)) %>%
  leaflet() %>%
  addTiles() %>%
  addPolylines() %>%
  addCircleMarkers(data = raw_journey_data %>%
    select(contains("start")) %>%
    setNames(c("long", "lat")),
    color = "green",
    opacity = 1,
    radius = 2) %>%
  addCircleMarkers(data = raw_journey_data %>%
    select(contains("end")) %>%
    setNames(c("long", "lat")),
    color = "red",
    opacity = 1,
    radius = 2) %>%
  addLegend(colors = c("green",
                       "red"),
            labels = c("Journey start",
                       "Journey end"))
```


## Functionalising journeys to sf

The function below uses [tidyeval](http://dplyr.tidyverse.org/articles/programming.html) to allow us to convert any `data.frame` containing pairs of start and end coordinates into an `sf` object we can use easily with other tools. **Please do note that this is probably not the most efficient method of doing this, I'd very much appreciate any improvements**.

```{r journeys-to-sf}
journeys_to_sf <- function(journeys_data,
                           start_long,
                           start_lat,
                           end_long,
                           end_lat) {
  
  quo_start_long <- enquo(start_long)
  quo_start_lat <- enquo(start_lat)
  quo_end_long <- enquo(end_long)
  quo_end_lat <- enquo(end_lat)
  
  start_locs <- journeys_data %>%
    select(!!quo_start_long,
           !!quo_start_lat) %>%
    setNames(c("long", "lat")) %>%
    mutate(journey_id = row_number())
  
  end_locs <- journeys_data %>%
    select(!!quo_end_long,
           !!quo_end_lat) %>%
    setNames(c("long", "lat")) %>%
    mutate(journey_id = row_number())
  
  journey_data_linestrings <- start_locs %>%
    bind_rows(end_locs) %>%
    st_as_sf(coords = c("long","lat")) %>%
    group_by(journey_id) %>%
    arrange(journey_id) %>%
    summarise() %>%
    st_cast("LINESTRING")
  
  journey_data_linestrings <- st_set_crs(journey_data_linestrings, st_crs(4326))
  
  journey_data <- raw_journey_data
  st_geometry(journey_data) <- st_geometry(journey_data_linestrings)
  
  journey_data
  
}
```

Here's how to use the function:

```{r example-of-function}
raw_journey_data %>%
  journeys_to_sf(start.long,
                 start.lat,
                 end.long,
                 end.lat)
```




<!--html_preserve-->
<hr>
<div class="row">
    <div class="col-sm-4">
        <center> <span class="fa fa-star fa-2x text-center" style="color:Tomato"></span>
            <p><a href='/reproducability-ratings' data-toggle="tooltip" data-placement="right" title="" data-original-title="Click for info" style='font-weight:bold;color:black;text-decoration:underline;' target='_blank'>Citable Author<i class="fa fa-question-circle "></i></a>
                <br>
                Martin John Hadley
                <br>
                (<a href="https://orcid.org/0000-0002-3039-6849" target="orcid.widget" rel="noopener noreferrer" style="vertical-align:top;"  target='_blank'><img src="/img/orcid_16x16.png" style="width:1em;margin-right:.2em;" alt="ORCID iD icon">orcid.org/0000-0002-3039-6849</a>)
        </center>
    </div>
    <div class="col-sm-4">
        <center> <span class="fa fa-star fa-2x text-center" style="color:Tomato"></span>
            <p><a href='/reproducability-ratings' data-toggle="tooltip" data-placement="right" title="" data-original-title="Click for info" style='font-weight:bold;color:black;text-decoration:underline;' target='_blank'>Citable Data<i class="fa fa-question-circle "></i></a>
                <br>
                No real data used.
        </center>
    </div>
    <div class="col-sm-4">
        <center> <span class="fa fa-star-half-o fa-2x text-center" style="color:Tomato"></span>
            <p><a href='/reproducability-ratings' data-toggle="tooltip" data-placement="right" title="" data-original-title="Click for info" style='font-weight:bold;color:black;text-decoration:underline;' target='_blank'>Citable Code<i class="fa fa-question-circle "></i></a>
                <br>
                <a href="https://github.com/visibledata/visibledata.github.io/blob/master/content/blog/2018-02-28_great-circles-with-sf.Rmd" target="orcid.widget" rel="noopener noreferrer" style="vertical-align:top;"  target='_blank'><img src="/img/GitHub-Mark-32px.png" style="width:1em;margin-right:.5em;" alt="GitHub icon">.Rmd on GitHub</a>
        </center>
    </div>
</div>

<!--/html_preserve-->





